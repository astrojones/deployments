name: Deploy Service

on:
  repository_dispatch:
    types: [deploy-prod, deploy-preview, cleanup-preview]

jobs:
  deploy:
    runs-on: ubuntu-latest
    # SECURITY: repository_dispatch events cannot be triggered from forks
    # Only repos with write access can send dispatch events
    # This prevents secret exposure from malicious PRs
    permissions:
      contents: write
      packages: write
    
    steps:
      - name: Checkout deployments repo
        uses: actions/checkout@v4
      
      - name: Check if template repo
        if: github.event.action == 'deploy-prod' || github.event.action == 'deploy-preview'
        id: check_template
        run: |
          IS_TEMPLATE=$(gh api repos/${{ github.event.client_payload.repository }} --jq '.is_template')
          echo "is_template=$IS_TEMPLATE" >> $GITHUB_OUTPUT
          echo "Template repo: $IS_TEMPLATE"
        env:
          GH_TOKEN: ${{ secrets.CHECKOUT_TOKEN }}
      
      - name: Create test repo from template
        if: (github.event.action == 'deploy-prod' || github.event.action == 'deploy-preview') && steps.check_template.outputs.is_template == 'true'
        id: create_test
        run: |
          TEST_REPO="validation-$(date +%s)"
          echo "ðŸ§ª Creating test repo from template: $TEST_REPO"
          
          gh repo create astrojones/$TEST_REPO \
            --template ${{ github.event.client_payload.repository }} \
            --private
          
          echo "test_repo=astrojones/$TEST_REPO" >> $GITHUB_OUTPUT
          echo "is_test_repo=true" >> $GITHUB_OUTPUT
          echo "âœ… Test repo created: $TEST_REPO"
        env:
          GH_TOKEN: ${{ secrets.CHECKOUT_TOKEN }}
      
      - name: Checkout app repository
        if: (github.event.action == 'deploy-prod' || github.event.action == 'deploy-preview') && steps.check_template.outputs.is_template != 'true'
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.client_payload.repository }}
          ref: ${{ github.event.client_payload.ref }}
          token: ${{ secrets.CHECKOUT_TOKEN }}
          path: app-code
      
      - name: Checkout test repository
        if: (github.event.action == 'deploy-prod' || github.event.action == 'deploy-preview') && steps.check_template.outputs.is_template == 'true'
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.create_test.outputs.test_repo }}
          token: ${{ secrets.CHECKOUT_TOKEN }}
          path: app-code
      
      # GitHub automatically authenticates to organization private registries
      # No explicit login needed - credentials injected via org settings
      
      - name: Build and push image
        if: github.event.action == 'deploy-prod' || github.event.action == 'deploy-preview'
        uses: docker/build-push-action@v5
        with:
          context: ./app-code
          push: true
          tags: ${{ github.event.client_payload.image }}
      
      - name: Setup SSH
        env:
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ vars.HOST_IP }} >> ~/.ssh/known_hosts
      
      - name: Deploy Production
        if: github.event.action == 'deploy-prod'
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          HOST_IP: ${{ vars.HOST_IP }}
          REGISTRY_URL: registry.jonaheidsick.de
          REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
          REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
        run: |
          APP_NAME="${{ github.event.client_payload.app_name }}"
          DOMAIN="${{ github.event.client_payload.domain }}"
          IMAGE="${{ github.event.client_payload.image }}"
          PORT="${{ github.event.client_payload.port || '80' }}"
          
          echo "ðŸš€ Deploying $APP_NAME to $DOMAIN"
          
          ssh $SSH_USER@$HOST_IP bash -s << EOF
            set -e
            mkdir -p /opt/apps/$APP_NAME
            cd /opt/apps/$APP_NAME
            
            # Login to registry on host for docker compose pull
            echo "$REGISTRY_PASSWORD" | docker login $REGISTRY_URL -u "$REGISTRY_USERNAME" --password-stdin
            
            # Create docker-compose.yml
            cat > docker-compose.yml << 'COMPOSE'
          services:
            app:
              image: $IMAGE
              restart: unless-stopped
              networks:
                - edge
              labels:
                - "traefik.enable=true"
                - "traefik.http.routers.$APP_NAME.rule=Host(\\\`$DOMAIN\\\`)"
                - "traefik.http.routers.$APP_NAME.entrypoints=websecure"
                - "traefik.http.routers.$APP_NAME.tls.certresolver=letsencrypt"
                - "traefik.http.services.$APP_NAME.loadbalancer.server.port=$PORT"

          networks:
            edge:
              external: true
          COMPOSE
            
            # Deploy
            docker compose pull
            docker compose up -d
            
            echo "âœ… Deployed $DOMAIN"
          EOF
      
      - name: Update registry for production
        if: github.event.action == 'deploy-prod'
        run: |
          REPO_NAME=$(echo "${{ github.event.client_payload.repository }}" | cut -d'/' -f2)
          DOMAIN="${{ github.event.client_payload.domain }}"
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Update registry.json
          jq ".deployments[\"$REPO_NAME\"] = {
            domain: \"$DOMAIN\",
            subdomain: \"${{ github.event.client_payload.subdomain }}\",
            base_domain: \"${{ github.event.client_payload.base_domain }}\",
            image: \"${{ github.event.client_payload.image }}\",
            deployed_at: \"$(date -Iseconds)\",
            commit: \"${{ github.event.client_payload.ref }}\"
          }" registry.json > registry.json.tmp && mv registry.json.tmp registry.json
          
          git add registry.json
          git commit -m "Deploy $REPO_NAME @ ${{ github.event.client_payload.ref }}"
          git push
          
          # Update GitHub topics on app repo
          gh api repos/${{ github.event.client_payload.repository }} --method PUT \
            -f topics[]=deployed \
            -f topics[]=env-prod \
            -f topics[]=domain-${DOMAIN//./-}
        env:
          GH_TOKEN: ${{ secrets.CHECKOUT_TOKEN }}
      
      - name: Deploy Preview
        if: github.event.action == 'deploy-preview'
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          HOST_IP: ${{ vars.HOST_IP }}
          REGISTRY_URL: registry.jonaheidsick.de
          REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
          REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
        run: |
          APP_NAME="${{ github.event.client_payload.app_name }}"
          DOMAIN="${{ github.event.client_payload.domain }}"
          IMAGE="${{ github.event.client_payload.image }}"
          PORT="${{ github.event.client_payload.port || '80' }}"
          
          echo "ðŸš€ Deploying preview $APP_NAME to $DOMAIN"
          
          ssh $SSH_USER@$HOST_IP bash -s << EOF
            set -e
            mkdir -p /opt/apps/$APP_NAME
            cd /opt/apps/$APP_NAME
            
            # Login to registry on host for docker compose pull
            echo "$REGISTRY_PASSWORD" | docker login $REGISTRY_URL -u "$REGISTRY_USERNAME" --password-stdin
            
            # Create docker-compose.yml
            cat > docker-compose.yml << 'COMPOSE'
          services:
            app:
              image: $IMAGE
              restart: unless-stopped
              networks:
                - edge
              labels:
                - "traefik.enable=true"
                - "traefik.http.routers.$APP_NAME.rule=Host(\\\`$DOMAIN\\\`)"
                - "traefik.http.routers.$APP_NAME.entrypoints=websecure"
                - "traefik.http.routers.$APP_NAME.tls.certresolver=letsencrypt"
                - "traefik.http.services.$APP_NAME.loadbalancer.server.port=$PORT"

          networks:
            edge:
              external: true
          COMPOSE
            
            # Deploy
            docker compose pull
            docker compose up -d
            
            echo "âœ… Deployed preview at $DOMAIN"
          EOF
      
      - name: Update registry for preview
        if: github.event.action == 'deploy-preview'
        run: |
          APP_NAME="${{ github.event.client_payload.app_name }}"
          DOMAIN="${{ github.event.client_payload.domain }}"
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Update registry.json
          jq ".preview_deployments[\"$APP_NAME\"] = {
            domain: \"$DOMAIN\",
            pr_number: ${{ github.event.client_payload.pr_number }},
            base_domain: \"${{ github.event.client_payload.base_domain }}\",
            subdomain: \"${{ github.event.client_payload.subdomain }}\",
            image: \"${{ github.event.client_payload.image }}\",
            deployed_at: \"$(date -Iseconds)\",
            pr_url: \"${{ github.event.client_payload.pr_url }}\"
          }" registry.json > registry.json.tmp && mv registry.json.tmp registry.json
          
          git add registry.json
          git commit -m "Preview $APP_NAME"
          git push
          
          # Update GitHub topics on app repo
          gh api repos/${{ github.event.client_payload.repository }} --method PUT \
            -f topics[]=deployed \
            -f topics[]=env-preview \
            -f topics[]=has-preview-pr-${{ github.event.client_payload.pr_number }}
        env:
          GH_TOKEN: ${{ secrets.CHECKOUT_TOKEN }}
      
      - name: Cleanup Preview
        if: github.event.action == 'cleanup-preview'
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          HOST_IP: ${{ vars.HOST_IP }}
        run: |
          APP_NAME="${{ github.event.client_payload.app_name }}"
          
          echo "ðŸ§¹ Cleaning up preview deployment: $APP_NAME"
          
          ssh $SSH_USER@$HOST_IP bash -s << EOF
            set -e
            if [ -d /opt/apps/$APP_NAME ]; then
              cd /opt/apps/$APP_NAME
              docker compose down -v || true
              cd ..
              rm -rf $APP_NAME
              echo "âœ… Removed preview deployment"
            else
              echo "âš ï¸  No deployment found to clean up"
            fi
          EOF
      
      - name: Update registry after cleanup
        if: github.event.action == 'cleanup-preview'
        run: |
          APP_NAME="${{ github.event.client_payload.app_name }}"
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Update registry.json
          jq "del(.preview_deployments[\"$APP_NAME\"])" registry.json > registry.json.tmp && mv registry.json.tmp registry.json
          
          git add registry.json
          git commit -m "Cleanup preview $APP_NAME" || true
          git push || true
        env:
          GH_TOKEN: ${{ secrets.CHECKOUT_TOKEN }}
      
      - name: Cleanup test repository
        if: always() && steps.create_test.outputs.is_test_repo == 'true'
        run: |
          TEST_REPO="${{ steps.create_test.outputs.test_repo }}"
          echo "ðŸ§¹ Deleting test repo: $TEST_REPO"
          gh repo delete $TEST_REPO --yes
          echo "âœ… Test repo deleted"
        env:
          GH_TOKEN: ${{ secrets.CHECKOUT_TOKEN }}
