name: Deploy Service

on:
  repository_dispatch:
    types: [deploy-prod, deploy-preview, cleanup-preview]

jobs:
  deploy:
    runs-on: ubuntu-latest
    # SECURITY: repository_dispatch events cannot be triggered from forks
    # Only repos with write access can send dispatch events
    # This prevents secret exposure from malicious PRs
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout app repository
        if: github.event.action == 'deploy-prod' || github.event.action == 'deploy-preview'
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.client_payload.repository }}
          ref: ${{ github.event.client_payload.ref }}
          token: ${{ secrets.CHECKOUT_TOKEN }}
      
      # GitHub automatically authenticates to organization private registries
      # No explicit login needed - credentials injected via org settings
      
      - name: Build and push image
        if: github.event.action == 'deploy-prod' || github.event.action == 'deploy-preview'
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ github.event.client_payload.image }}
      
      - name: Setup SSH
        env:
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ vars.HOST_IP }} >> ~/.ssh/known_hosts
      
      - name: Deploy Production
        if: github.event.action == 'deploy-prod'
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          HOST_IP: ${{ vars.HOST_IP }}
          REGISTRY_URL: registry.jonaheidsick.de
          REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
          REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
        run: |
          APP_NAME="${{ github.event.client_payload.app_name }}"
          DOMAIN="${{ github.event.client_payload.domain }}"
          IMAGE="${{ github.event.client_payload.image }}"
          PORT="${{ github.event.client_payload.port || '80' }}"
          
          echo "ðŸš€ Deploying $APP_NAME to $DOMAIN"
          
          ssh $SSH_USER@$HOST_IP bash -s << EOF
            set -e
            mkdir -p /opt/apps/$APP_NAME
            cd /opt/apps/$APP_NAME
            
            # Login to registry on host for docker compose pull
            echo "$REGISTRY_PASSWORD" | docker login $REGISTRY_URL -u "$REGISTRY_USERNAME" --password-stdin
            
            # Create docker-compose.yml
            cat > docker-compose.yml << 'COMPOSE'
          services:
            app:
              image: $IMAGE
              restart: unless-stopped
              networks:
                - edge
              labels:
                - "traefik.enable=true"
                - "traefik.http.routers.$APP_NAME.rule=Host(\\\`$DOMAIN\\\`)"
                - "traefik.http.routers.$APP_NAME.entrypoints=websecure"
                - "traefik.http.routers.$APP_NAME.tls.certresolver=letsencrypt"
                - "traefik.http.services.$APP_NAME.loadbalancer.server.port=$PORT"

          networks:
            edge:
              external: true
          COMPOSE
            
            # Deploy
            docker compose pull
            docker compose up -d
            
            echo "âœ… Deployed $DOMAIN"
          EOF
      
      - name: Deploy Preview
        if: github.event.action == 'deploy-preview'
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          HOST_IP: ${{ vars.HOST_IP }}
          REGISTRY_URL: registry.jonaheidsick.de
          REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
          REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
        run: |
          APP_NAME="${{ github.event.client_payload.app_name }}"
          DOMAIN="${{ github.event.client_payload.domain }}"
          IMAGE="${{ github.event.client_payload.image }}"
          PORT="${{ github.event.client_payload.port || '80' }}"
          
          echo "ðŸš€ Deploying preview $APP_NAME to $DOMAIN"
          
          ssh $SSH_USER@$HOST_IP bash -s << EOF
            set -e
            mkdir -p /opt/apps/$APP_NAME
            cd /opt/apps/$APP_NAME
            
            # Login to registry on host for docker compose pull
            echo "$REGISTRY_PASSWORD" | docker login $REGISTRY_URL -u "$REGISTRY_USERNAME" --password-stdin
            
            # Create docker-compose.yml
            cat > docker-compose.yml << 'COMPOSE'
          services:
            app:
              image: $IMAGE
              restart: unless-stopped
              networks:
                - edge
              labels:
                - "traefik.enable=true"
                - "traefik.http.routers.$APP_NAME.rule=Host(\\\`$DOMAIN\\\`)"
                - "traefik.http.routers.$APP_NAME.entrypoints=websecure"
                - "traefik.http.routers.$APP_NAME.tls.certresolver=letsencrypt"
                - "traefik.http.services.$APP_NAME.loadbalancer.server.port=$PORT"

          networks:
            edge:
              external: true
          COMPOSE
            
            # Deploy
            docker compose pull
            docker compose up -d
            
            echo "âœ… Deployed preview at $DOMAIN"
          EOF
      
      - name: Cleanup Preview
        if: github.event.action == 'cleanup-preview'
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          HOST_IP: ${{ vars.HOST_IP }}
        run: |
          APP_NAME="${{ github.event.client_payload.app_name }}"
          
          echo "ðŸ§¹ Cleaning up preview deployment: $APP_NAME"
          
          ssh $SSH_USER@$HOST_IP bash -s << EOF
            set -e
            if [ -d /opt/apps/$APP_NAME ]; then
              cd /opt/apps/$APP_NAME
              docker compose down -v || true
              cd ..
              rm -rf $APP_NAME
              echo "âœ… Removed preview deployment"
            else
              echo "âš ï¸  No deployment found to clean up"
            fi
          EOF
